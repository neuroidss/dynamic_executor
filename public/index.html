<!DOCTYPE html>
 <html>
 <head>
     <title>Infinite MMORPG - Orb of Ingenuity Demo</title>
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <style>
         body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; background-color: #f0f0f0; }
         #game-container { flex-grow: 1; display: flex; flex-direction: column; padding: 10px; overflow: hidden; }
         #log-area { flex-basis: 55%; background-color: #fff; border: 1px solid #ccc; padding: 10px; overflow-y: scroll; margin-bottom: 10px; font-size: 0.9em; }
         #log-area p { margin: 2px 0; }
         #status-area { font-size: 0.9em; margin-bottom: 10px; padding: 5px; background-color: #e9e9e9; border-radius: 4px;}
         #action-area { flex-basis: 40%; overflow-y: auto; background-color: #fff; border: 1px solid #ccc; padding: 10px; }
         #action-buttons button { display: block; width: 95%; margin: 5px auto; padding: 10px 15px; font-size: 1em; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; text-align: left; }
          #action-buttons button:hover { background-color: #45a049; }
          #action-buttons button .desc { font-size: 0.8em; color: #e0e0e0; display: block; margin-top: 3px;}
         #debug-area { position: fixed; bottom: 0; right: 0; background: rgba(0,0,0,0.7); color: lime; font-family: monospace; font-size: 0.7em; max-height: 100px; overflow-y: scroll; padding: 5px; max-width: 300px; opacity: 0.8; z-index: 100;}
          h3 {margin-top: 0; margin-bottom: 5px; text-align: center; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
     </style>
     <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>
 </head>
 <body>
     <div id="game-container">
         <div id="log-area">
             <h3>World Log</h3>
             <div id="log-content"></div>
         </div>
         <div id="status-area">
              Loading...
         </div>
         <div id="action-area">
             <h3>Available Actions (Inventory)</h3>
             <div id="action-buttons">
                 <!-- Action buttons will be generated here -->
             </div>
         </div>
     </div>
      <div id="debug-area">
          <div id="debug-content"></div>
      </div>

     <script>
         const socket = io(); 

         const logContent = document.getElementById('log-content');
         const statusArea = document.getElementById('status-area');
         const actionButtons = document.getElementById('action-buttons');
         const debugContent = document.getElementById('debug-content');

         let playerSoulId = null;
         let currentGameState = {};

         function addLogMessage(message, type = 'info') {
             const p = document.createElement('p');
             p.textContent = message;
             if (type === 'error') p.style.color = 'red';
             if (type === 'success') p.style.color = 'green';
             if (type === 'event') { p.style.color = 'blue'; p.style.fontWeight = 'bold';}
             logContent.appendChild(p);
             logContent.scrollTop = logContent.scrollHeight; 
         }

         function addDebugMessage(message) {
             const d = document.createElement('div');
             d.textContent = message;
             debugContent.appendChild(d);
             debugContent.scrollTop = debugContent.scrollHeight; 
         }

         function updateStatus(state) {
              if (!state || !state.playerSoul || !state.currentLocation) {
                  statusArea.innerHTML = "Waiting for server data...";
                  return;
              }
              currentGameState = state; 

              let statusHTML = `
                  <strong>${state.playerSoul.name}</strong> (ID: ${state.playerSoul.id})<br>
                  Location: <strong>${state.currentLocation.name}</strong><br>
                  <em>${state.currentLocation.description}</em><br>
                  Exits: ${Object.entries(state.currentLocation.exits || {}).map(([dir, loc_id]) => `${dir}: ${loc_id}`).join(', ') || 'None'} <br>
                  Landmarks: ${state.currentLocation.landmarks ? Object.entries(state.currentLocation.landmarks).map(([id, desc]) => `${id}: "${desc}"`).join('; ') : 'None'} <br>
                  Temporary Notes: ${state.currentLocation.temporary_notes || 'None'} <br>
                  Inventory: ${state.inventory ? state.inventory.map(a => a.name).join(', ') : 'Empty'}
              `;
              statusArea.innerHTML = statusHTML;
         }

         function updateLog(logEntries) {
              if (!logEntries) return;
              logContent.innerHTML = ''; 
              logEntries.forEach(msg => addLogMessage(msg));
         }

         function renderActions(actions) {
             actionButtons.innerHTML = ''; 
             if (!actions || actions.length === 0) {
                 actionButtons.innerHTML = '<p>No actions available from inventory.</p>';
                 return;
             }

             actions.forEach(actionArtifact => { // actionArtifact is an item from inventory
                 const button = document.createElement('button');
                 button.dataset.artifactId = actionArtifact.id;
                 
                 let actionDisplayName = actionArtifact.name;
                 let actionDescription = actionArtifact.description || `(Use ${actionArtifact.name})`;
                 let eventToEmit = 'performAction'; // Default event

                 button.innerHTML = `${actionDisplayName} <span class="desc">${actionDescription}</span>`;

                 button.onclick = () => {
                     addDebugMessage(`Clicked action: ${actionDisplayName} (Artifact ID: ${actionArtifact.id}, Linked Func: ${actionArtifact.toolName || 'N/A'})`);
                     let args = {};

                     // Argument collection for specific dynamic functions (based on linked_dynamic_function_name)
                     if (actionArtifact.toolName === 'df_interact_with_pedestal') {
                         const targetPedestal = prompt("Which pedestal to use this on? (e.g., pedestal_fire, pedestal_water, pedestal_wind)");
                         if (!targetPedestal) return; // User cancelled
                         args.target_pedestal_id = targetPedestal.trim();
                     }
                     // No specific args needed for df_initiate_orb_tool_creation from client initially
                     // No specific args needed for df_use_vault_key from client initially (contextual)
                     // No specific args needed for light bridge (LLM will be prompted for fixed target)
                    
                     socket.emit(eventToEmit, {
                         artifactId: actionArtifact.id, 
                         args: args 
                     });
                 };
                 actionButtons.appendChild(button);
             });
         }

         socket.on('connect', () => {
             addLogMessage('Connected to the Orb of Ingenuity Demo!', 'success');
             addDebugMessage(`Connected with socket ID: ${socket.id}`);
         });

         socket.on('disconnect', () => {
             addLogMessage('Disconnected from the server.', 'error');
         });

          socket.on('assignSoulId', (id) => {
              playerSoulId = id;
              addDebugMessage(`Assigned Player Soul ID: ${playerSoulId}`);
              socket.emit('requestState'); // Request initial state after getting soul ID
          });

         socket.on('gameStateUpdate', (state) => {
             addDebugMessage('Received gameStateUpdate');
              if (state.error){
                  addLogMessage(`Server Error: ${state.error}`, 'error');
                  return;
              }
             updateStatus(state);
             updateLog(state.worldLog); // Assumes worldLog is part of the main state update
         });

         socket.on('availableActions', (actions) => { // These are derived from inventory artifacts
             addDebugMessage(`Received ${actions ? actions.length : 0} available actions from inventory.`);
             renderActions(actions);
         });

         socket.on('actionResult', (result) => {
              addDebugMessage(`Action Result: Success=${result.success}, Msg=${result.message}`);
              addLogMessage(result.message, result.success ? 'success' : 'error');

              if (result.success && result.message === "EVENT:PROMPT_USER_FOR_TOOL_DESCRIPTION") {
                  addLogMessage("The Orb of Ingenuity hums, awaiting your command...", 'event');
                  const userDescription = prompt("Describe the new power for the Orb of Ingenuity (e.g., 'Create a temporary light bridge to the keyhole platform'):");
                  if (userDescription && userDescription.trim() !== "") {
                      socket.emit('submitToolDescription', {
                          description: userDescription.trim(),
                          catalyst_artifact_id: result.prompt_for_tool_artifact_id 
                      });
                  } else {
                      addLogMessage("Orb command cancelled.", 'info');
                  }
              }
         });

          socket.on('debugInfo', (message) => {
              addDebugMessage(message);
          });
         
         socket.on('requestState', () => { 
                addDebugMessage('Server requested state refresh (or client is re-requesting).');
               if(playerSoulId) {
                   socket.emit('requestState'); 
               }
           });

         addLogMessage('Attempting to connect to server...');
     </script>
 </body>
 </html>
